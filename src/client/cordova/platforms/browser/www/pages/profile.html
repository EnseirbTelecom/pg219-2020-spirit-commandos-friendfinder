<template>
    <div class="page" data-name="notifs">
        <div class="scrollbar-warm-flame d-none" id="menuProfile">
            <div class="w3-sidebar w3-bar-block w3-black w3-xxlarge w3-animate-zoom" style="width:70px">
                <a href="#" class="w3-bar-item w3-button"><i class="fa fa-home" title="page d'accueil"></i></a>
                <a href="#" @click="getPos" class="w3-bar-item w3-button"><i class="fa fa-thumb-tack"
                        title="Ajouter une nouvelle position"></i></a>
                <a href="#" @click="params" class="w3-bar-item w3-button"><i class="fa fa-gear"
                        title="modifier les paramètres de votre compte"></i></a>
                <a href="#" class="w3-bar-item w3-button"><i class="fa fa-search" title="rechercher"></i></a>
                <a href="#" @click="amis" class="w3-bar-item w3-button"><i class="fa fa-group"
                        title="liste des amis"></i></a>
                <a href="#" class="w3-bar-item w3-button"><i class="fa fa-history"
                        title="historique des positions"></i></a>
                <a href="#" @click="deconnecter" class="w3-bar-item w3-button"><i class="fa fa-power-off"
                        title="Déconnexion"></i></a>

            </div>
        </div>

        <div>
            <div id="containProfile">
                <nav class="navbar navbar-dark">
                    <a class="navbar-brand" href="#" @click="show_menu"><i class="icon f7-icons"
                            style="color: white;">menu</i></a>
                    <a href="#" @click="bell" style="color: white; margin-left: 50%;"><i class="icon f7-icons">bell</i>
                        {{#if cpt}}
                        <span id="span_notifs"></span>
                        {{/if}}
                    </a>
                    <a href="#" @click="deconnecter" style="color: white; "><i class="icon f7-icons">power</i></a>
                </nav>
                {{#profile}}
                <div id="card-accept">
                    <i class="fas fa-user" id="icon-profile"></i>
                    <!-- <i class="icon f7-icons" id="icon-profile">person</i> -->
                    <ul>
                        <li>mail: {{mail}}</li>
                        <li>nom: {{nom}}</li>
                        <li>prenom: {{prenom}}</li>
                        <li>pseudo: {{pseudo}}</li>
                    </ul>
                    <div class="block">
                        <div class="row" id="buttons">
                            <!-- <a class="col button button-fill btn-accept" style="margin-right: 1%;">Accepter</a> -->
                            <a @click="delete('{{_id}}')" class="col button button-fill btn-delete" id="btn">Supprimer</a>
                        </div>
                    </div>
                </div>
                {{/profile}}
            </div>
        </div>
</template>
<script>
    return {
        async data() {
            // On cherche les notifications de l'utilisateur
            let url = "http://localhost:3000/notifs/" + this.$route.params.token;
            let notifs = [];
            let cpt = 0;
            try {
                notifs = await fetch(url)
                    .then(res =>
                        res.json())
            } catch (err) {
                let url = "http://10.0.2.2:3000/notifs/" + this.$route.params.token;
                try {
                    notifs = await fetch(url)
                        .then(res =>
                            res.json())
                } catch (err) {
                    this.$app.dialog.alert("Error " + err);
                }
            }
            console.log("notifs: " + JSON.stringify(notifs));
            cpt = notifs.length;
            // console.log(JSON.stringify(this.$route.params.friend));
            url = "http://10.0.2.2:3000/getUserProfile/" + this.$route.params.token + "/" + this.$route.params.friend;
            let profile = [];
            try {
                profile = await fetch(url)
                    .then(res =>
                        res.json())
            } catch (err) {
                url = "http://localhost:3000/getUserProfile/" + this.$route.params.token + "/" + this.$route.params.friend;
                try {
                    profile = await fetch(url)
                        .then(res =>
                            res.json())
                } catch (err) {
                    this.$app.dialog.alert("Error: " + err);
                }
            }
            return {
                notifs: notifs,
                cpt: cpt,
                profile: profile
            }
        },
        methods: {
            params: function() {
                console.log("Vous voulez modifier votre mot de passe");
                console.log(this.$route.params.token);
                this.$router.navigate("/parameters/" + this.$route.params.token);
            },
            getPos: function() {
                this.$router.navigate("/AddPosition/" + this.$route.params.token);
            },
            show_menu: function() {
                console.log("menu: " + document.getElementById("menuProfile").innerHTML);
                if (document.getElementById("menuProfile").classList.contains("d-none")) {
                    document.getElementById("menuProfile").classList.remove("d-none");
                    document.getElementById("containProfile").style.marginLeft = "70px";
                } else {
                    document.getElementById("menuProfile").classList.add("d-none");
                    document.getElementById("containProfile").style.marginLeft = "0px";
                }
            },
            amis: function() {
                this.$router.navigate("/amis/" + this.$route.params.token);
            },
            deconnecter: function() {
                // this.$app.dialog.confirm("Êtes vous sûr de vouloir quitter cette session ?", function () {
                //     this.$router.navigate("/off/");
                // })
                this.$router.navigate("/off/");
            },
            bell: function() {
                this.$router.navigate("/notifs/" + this.$route.params.token);
            },
            delete: function(id) {
                let url = "http://10.0.2.2:3000/friend/" + this.$route.params.token + "/" + id;
                fetch(url, {
                    method: "DELETE"
                }).then(res => {
                    return res.json()
                }).then(data => {
                    if (data === "OK") {
                        console.log(data);
                        this.$app.dialog.alert('Cet utilisateur a été supprimé de la liste de vos amis', () => {
                            this.$router.navigate("/amis/" + this.$route.params.token);
                        });
                    }
                })
            },
            deconnecter: function() {
                // this.$app.dialog.confirm("Êtes vous sûr de vouloir quitter cette session ?", function() {
                //     // this.$router.navigate("/");
                //     this.$app.dialog.alert("GREAT!");
                // });
                this.$router.navigate("/");
            },
            bell: function() {
                this.$router.navigate("/notifs/" + this.$route.params.token);
            }
        }
    }
</script>