<template>
    <div class="page" data-name="historique">
        <!-- <ul> -->
        {{#each positions}}
        <!-- <li> -->
        <div>
            <h3>Position {{@index}}: </h3>
            <div style="margin-left: 5%;">
                <h6>{{address}}</h6>
                <h6>{{context}}</h6>
                <h6>partagée le {{date_activation}} à {{heure_activation}}</h6>
                <h6>message: {{msg}}</h6>
            </div>
            <!-- <h6></h6> -->
        </div>

        <!-- </li> -->
        {{/each}}
        <!-- </ul> -->
        <a @click="getMap">show map</a>
        <div id="map"></div>

    </div>
</template>
<script>
    return {
        async data() {
            // // On cherche les notifications de l'utilisateur
            let url;
            // if (window.cordova === undefined) {
            //     url = "http://localhost:3000/notifs/" + this.$route.params.token;
            //     console.log("Browser");
            // } else {
            //     url = "http://10.0.2.2:3000/notifs/" + this.$route.params.token;;
            //     console.log(window.cordova.platformId);
            // }
            // let notifs = [];
            // let cpt = 0;
            // try {
            //     notifs = await fetch(url)
            //         .then(res =>
            //             res.json())
            // } catch (err) {
            //     this.$app.dialog.alert("Error " + err);
            // }
            // console.log("notifs: " + JSON.stringify(notifs));
            // cpt = notifs.length;
            // return {
            //     notifs: notifs,
            //     cpt: cpt
            // }
            let positions = [];
            if (window.cordova === undefined) {
                url = "http://localhost:3000/positions/" + this.$route.params.token;
                console.log("Browser");
            } else {
                url = "http://10.0.2.2:3000/positions/" + this.$route.params.token;;
                console.log(window.cordova.platformId);
            }
            try {
                positions = await fetch(url).then(res =>
                    res.json())
            } catch (err) {
                this.$app.dialog.alert("ERROR: " + err);
            }
            for (let i = 0; i < positions.length; i++) {
                let address = await fetch('https://api-adresse.data.gouv.fr/reverse/?lon=' + positions[i].long + '&lat=' + positions[i].lat).then(res =>
                    res.json());
                // console.log(address.features[0].properties.label + address.features[0].properties.context);
                positions[i].address = address.features[0].properties.label;
                positions[i].context = address.features[0].properties.context;
                console.log(positions[i].address);
                console.log(positions[i].context);

            }
            return {
                positions: positions
            }
        },
        methods: {
            getMap: async function() {
                let positions = [];
                if (window.cordova === undefined) {
                    url = "http://localhost:3000/positions/" + this.$route.params.token;
                    console.log("Browser");
                } else {
                    url = "http://10.0.2.2:3000/positions/" + this.$route.params.token;
                    console.log(window.cordova.platformId);
                }
                try {
                    positions = await fetch(url).then(res =>
                        res.json())
                } catch (err) {
                    this.$app.dialog.alert("ERROR: " + err);
                }
                console.log("liste des positions: " + JSON.stringify(positions));
                for (pos in positions) {
                    //var marker = L.marker([villes[ville].lat, villes[ville].lon]).addTo(macarte);
                    console.log("pos latitude : "+ positions[pos].lat + " longitude : " + positions[pos].long);
                }
                let macarte = null;
                var lat = 44.839683;
                var lon = -0.570618;
                
                // Créer l'objet "macarte" et l'insèrer dans l'élément HTML qui a l'ID "map"
                macarte = L.map('map').setView([lat, lon], 11);
                // Leaflet ne récupère pas les cartes (tiles) sur un serveur par défaut. Nous devons lui préciser où nous souhaitons les récupérer. Ici, openstreetmap.fr
                L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {
                    // Il est toujours bien de laisser le lien vers la source des données
                    attribution: 'données © <a href="//osm.org/copyright">OpenStreetMap</a>/ODbL - rendu <a href="//openstreetmap.fr">OSM France</a>',
                    minZoom: 1,
                    maxZoom: 20
                }).addTo(macarte);
                
                for (pos in positions) {
                    var marker = L.marker([positions[pos].lat, positions[pos].long]).addTo(macarte);
                    marker.bindPopup("date: " + positions[pos].date_activation);
                }
            }
        }
    }
</script>