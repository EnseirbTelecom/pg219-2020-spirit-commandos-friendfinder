<template>
    <div class="page" data-name="params">
        <div class="scrollbar-warm-flame">
            <div class="w3-sidebar w3-bar-block w3-black w3-xxlarge" style="width:70px">
              <a href="#" class="w3-bar-item w3-button"><i class="fa fa-home" title="page d'accueil"></i></a> 
              <a href="#" class="w3-bar-item w3-button"><i class="fa fa-thumb-tack"  title="position"></i></a>
              <a href="#" class="w3-bar-item w3-button"><i class="fa fa-gear" title="modifier les paramètres de votre compte"></i></a> 
              <a href="#" class="w3-bar-item w3-button"><i class="fa fa-search" title="rechercher"></i></a> 
              <a href="#" class="w3-bar-item w3-button"><i class="fa fa-group" title="liste des amis"></i></a> 
              <a href="#" class="w3-bar-item w3-button"><i class="fa fa-history" title="historique des positions"></i></a>
            </div>
        </div>
        <div style="margin-left:70px">
            <div class="w3-container">
                <nav class="navbar navbar-dark bg-dark">
                    <a class="navbar-brand">Friend Finder</a>
                    <a href="#"  id="signup_link">Déconnexion</a>
                </nav>
                <h1 class="title">Paramètres: </h1>
                <ul>
                    <li>
                        <a href="#" @click="show_form">changer le mot de passe</a>
                        <div style="visibility: none;" id="form_modify" class="d-none">
                            <div style="border: black solid 0.3rem; border-radius: 0.3rem; margin-left: 5%; margin-top: 2%; margin-right: 15%;" >
                                <div style="margin-left: 2%;">
                                <div class="form-group">
                                    <label for="old_mdp">Ancien mot de passe: </label>
                                    <input id="old_mdp" type="password" class="form-control field" placeholder="password">
                                </div>
                                <div class="form-group">
                                    <label for="mdp">Nouveau mot de passe: </label>
                                    <input id="mdp" type="password" class="form-control field" placeholder="password">
                                </div>
                                <div class="form-group">
                                    <label for="new_mdp">Confirmer le mot de passe: </label>
                                    <input id="new_mdp" type="password" class="form-control field" placeholder="password">
                                    <p style="color: red; visibility: hidden;" id="non_conforme">Les deux mots de passe doivent être conformes !</p>
                                </div>
                            <div class="add" style="margin-left: 40%; margin-right: 40%;">
                                <a @click="modify" href="#" class="button button-round button-fill">changer le mot de passe</a>
                            </div>
                        </div>
                    </li>
                    <li>
                        <a href="#" class="disabled">changer l'adresse mail</a>
                    </li>
                    <li>
                        <a href="#" class="disabled">changer la photo de profil</a>
                    </li>

                </ul>
                
                
                <div class="fab " id="back">
                    <a  @click="back" href="#" title="Ajouter un produit">
                        <i class="icon f7-icons">arrow_left</i>
                    </a>
                </div>

            </div>
        </div>
    </div>
</template>
<script>
    return {
        methods: {
            show_form: function() {
                console.log("show form");
                // w3.includeHTML();
                document.getElementById("form_modify").classList = "d-visible";
            },
            modify: function() {
                console.log("modify");
                console.log("token: " + this.$route.params.token);
                let old_mdp = document.getElementById("old_mdp").value;
                let new_mdp = document.getElementById("mdp").value;
                let mdp = document.getElementById("new_mdp").value;
                if (new_mdp !== mdp) {
                    document.getElementById("non_conforme").style.visibility = "visible";
                    console.log("mots de passe non conformes");
                } 
                else {
                    console.log("mots de passe conformes !");
                    let url = "http://localhost:3000/newPassword/" + this.$route.params.token;
                    console.log("URL: " + url);
                    let reqBody = JSON.stringify({
                            old: old_mdp,
                            new_mdp: new_mdp
                        });
                    console.log("BODY:  " + reqBody);
                    try {
                        fetch(url, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: reqBody
                    }).then(res => {
                            return res.json();
                        }).then(data => {
                            console.log(JSON.stringify(data));
                            if (data === "OK") {
                                this.$app.dialog.alert("Mot de passe changé avec succès !");
                                document.getElementById("form_modify").classList = "d-none";        
                            }
                            else {
                                this.$app.dialog.alert("Something went wrong");
                            }
                        })
                    } catch (err) {
                        url = "http://10.0.2.2:3000/newPassword/" + this.$route.params.token;
                        fetch(url, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: reqBody
                    }).then(res => {
                            return res.json();
                        }).then(data => {
                            console.log(JSON.stringify(data));
                            if (data === "OK") {
                                this.$app.dialog.alert("Mot de passe changé avec succès !");
                                document.getElementById("form_modify").classList = "d-none";        
                            }
                            else {
                                this.$app.dialog.alert("Something went wrong");
                            }
                        })
                    }
                    
                    
                }
            },
            back: function() {
                this.$router.back();
            }
        }
    }
</script>